<!DOCTYPE html>
<html>
    <head>
        <title>Analyzing Scouting Data</title>
        <link rel = "stylesheet" href = "assets/index.css">
	    <link rel = "stylesheet" href = "assets/bootstrap.css">
        <link rel="stylesheet" href="assets/data.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
	    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
    </head>
    <body id="back">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- Navbar with search functionality -->
        <div class="navbar" id="navbar">
			<ul class = "nav nav-tabs">
				<li class="nav-item">
					<a class="nav-link" id = "navPregame" href = "report">Overview</a>
				</li>
				<li class="nav-item active">
					<a class="nav-link" id = "navPregame" href = "data">Team Data</a>
				</li>
				<input type="text" class = "nav-item" id = "search" placeholder="Search....">
			</ul>
            <hr class="navBottom" />
        </div>
        <!-- Page with all the data -->
		<div id="dataField">
			<center>
				<canvas id="hotSpotMap" width="824" height="346"></canvas>
			</center>
			<!-- Auton/Teleop Buttons-->
			<div class="row mapControl" style = "width: 98%;">
				<div class="col-md-6" >
					<button id="autonBtn" class="btn btn-primary btn-lg btn-block" type="button" onclick="updateMap('Auton');">Auton</button>
				</div>
				<div class="col-md-6" >
					<button id="teleopBtn" class="btn btn-primary btn-lg btn-block" type="button" onclick="updateMap('Teleop');">Teleop</button>
				</div>
			</div>
			<div id="dataCards" style = "width: 98%;">
				<div class="row">
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Top Intake</h4>
						<p id="topIntake"></p>
					</div>
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Floor Intake</h4>
						<p id="floorIntake"></p>
					</div>
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Typical Alliance Station</h4>
						<p id="allianceStation"></p>
					</div>
				</div>
				<div class="row">
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Attempted Lower</h4>
						<p id="attemptedLower"></p>
						<h4>Successful:</h4>
						<p id="sLow"></p>
					</div>
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Attempted Middle</h4>
						<p id="attemptedMiddle"></p>
						<h4>Successful:</h4>
						<p id="sMid"></p>
					</div>
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Attempted High</h4>
						<p id="attemptedHigh"></p>
						<h4>Successful:</h4>
						<p id="sHigh"></p>
					</div>
					<div class="col-md-2 col-md-offset-1 infoCard">
						<h4>Attempted Traversal</h4>
						<p id="attemptedTrav"></p>
						<h4>Successful:</h4>
						<p id="sTrav"></p>
					</div>
				</div>
			</div>
		</div>
		<!-- Scripts -->
		<script>
			var canvas = document.getElementById("hotSpotMap");
			var context = canvas.getContext('2d');
			var currentData;
			document.getElementById("search").addEventListener("keypress",function(event) {
				//Enter Key Code: 13
				if(event.keyCode === 13) {
					event.preventDefault();
					//Get Team Data
					getData();
				}
			});

			function getData() {
				let team = document.getElementById("search").value;
				$.getJSON("/team/" + team, function(data){
					currentData = data;
					let field_image = new Image();
					field_image.src = "assets/field.png";
					field_image.onload = function() {
						context.drawImage(field_image, 0,0);
						//Draw Auton dots on the map
						drawShotDots(data["Auton"]);

						var typicalAllianceStation;
						var attemptedLower = 0;
						var attemptedMiddle = 0;
						var attemptedHigh = 0;
						var attemptedTrav = 0;

						var sLow = 0;
						var sMid = 0;
						var sHigh = 0;
						var sTrav = 0;

						let timesL = 0;
						let timesM = 0;
						let timesR = 0;
						for(var i = 0; i < data["Data"].length; i++) {
							let d = data["Data"][i];
							if(d.AttemptedLower) {
								attemptedLower++;
							}
							if(d.AttemptedMiddle) {
								attemptedMiddle++;
							}
							if(d.AttemptedHigh) {
								attemptedHigh++;
							}
							if(d.AttemptedTrav) {
								attemptedTrav++;
							}

							switch (d.Successful) {
								case 4:
									sTrav++;
									break;
								case 3:
									sHigh++;
									break;
								case 2:
									sMid++;
									break;
								case 1:
									sLow++;
									break;
							}
							if(data["Data"][i].AllianceStation == "l") {
								timesL++;
							} else if (data["Data"][i].AllianceStation == "m") {
								timesM++;
							} else {
								timesR++;
							}
						}

						console.log(sHigh);
						console.log(sMid);
						let total = timesL + timesM + timesR;
						let avgL = timesL / total;
						let avgR = timesR / total;
						let avgM = timesM / total;
						if(avgL > avgM) {
							if(avgL > avgR) {
								typicalAllianceStation = 'Left';
							} else {
								typicalAllianceStation = 'Right';
							}
						} else {
							if(avgM > avgR) {
								typicalAllianceStation = 'Middle';
							} else {
								typicalAllianceStation = 'Right';
							}
						}

						
						
						//Cards
						document.getElementById("topIntake").innerText = data["Data"][0].TopIntake ? "Yes" : "No";
						document.getElementById("floorIntake").innerText = data["Data"][0].FloorIntake ? "Yes" : "No";
						document.getElementById("allianceStation").innerText = typicalAllianceStation;
						

						document.getElementById("attemptedLower").innerText = attemptedLower + " times";
						document.getElementById("attemptedMiddle").innerText = attemptedMiddle + " times";
						document.getElementById("attemptedHigh").innerText = attemptedHigh + " times";
						document.getElementById("attemptedTrav").innerText = attemptedTrav + " times";

						document.getElementById("sLow").innerText = "0%";
						document.getElementById("sMid").innerText = (((sTrav + sHigh + sMid) / attemptedMiddle) * 100) + "%";
						document.getElementById("sHigh").innerText = ((sTrav + sHigh/attemptedHigh) * 100) + "%";
						document.getElementById("sTrav").innerText = ((sTrav/attemptedTrav) * 100) + "%"; 

	
					};	
					
				});
			}
			
			function updateMap(mode) {
				let autonBtn = document.getElementById("autonBtn");
				let teleopBtn = document.getElementById("teleopBtn");
				if(mode == "Auton") {
					drawShotDots(currentData["Auton"]);
					autonBtn.classList.add("active");
					teleopBtn.classList.remove("active");
				} else {
					drawShotDots(currentData["Teleop"]);
					autonBtn.classList.remove("active");
					teleopBtn.classList.add("active");
				}
			}
			function drawShotDots(auton) {
				context.clearRect(0,0, canvas.width, canvas.height);
				let field_image = new Image();
				field_image.src = "assets/field.png";
				field_image.onload = function (){
					context.drawImage(field_image, 0, 0);
					context.fillStyle = 'orange';
					for(var i = 0; i < auton.length; i++) {
						let shot = auton[i];

						context.fillRect(shot.X, shot.Y, 5, 5);
					}
				};
			}
		</script>
        <!-- Sources -->
        
	    <script src = "assets/bootstrap.js"></script>
    </body>
</html>